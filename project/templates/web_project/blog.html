{% extends "base/base.html" %}
{% load static %}
{% block body_style %}
    background-image: url({% static 'images/author.jpg' %}); background-size: cover; background-position: center;
    background-repeat: no-repeat;
{% endblock %}
{% block title %}Блог автора{% endblock %}

{% block content %}
    <h1 class="text-center mb-4">Последние новости</h1>

    {% if news_list %}
        <div class="row g-4">
            {% for news in news_list %}
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm border-warning border-3 rounded-4 bg-secondary-subtle text-secondary">
                        {% if news.image %}
                            <img id="image-{{ news.id }}" src="{{ news.image.url }}" class="card-img-top object-fit-cover"
                                 alt="{{ news.title }}"
                                 style="height: 200px; width: 100%; border-radius: 0.5rem; margin: 0 auto; padding: 0.5rem;">
                        {% else %}
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center"
                                 style="height: 200px; width: 100%; border-radius: 0.5rem; margin: 0 auto; padding: 0.5rem;">
                                <span class="text-muted">Изображение отсутствует</span>
                            </div>
                        {% endif %}

                        <div class="card-body d-flex flex-column p-3">
                            <h5 id="title-{{ news.id }}" class="card-title">{{ news.title }}</h5>
                            <p id="content-{{ news.id }}" class="card-text flex-grow-1">
                                {{ news.content|truncatechars:200 }}
                            </p>
                            <div class="mt-auto">
                                <small class="text-muted">
                                    <i class="bi bi-person-circle me-1"></i>{{ news.author }} ·
                                    <i class="bi bi-clock-history me-1"></i>{{ news.created_at|date:"d M Y в H:i" }}
                                </small>
                            </div>
                            <a href="{% url 'news_detail' news.id %}" class="btn btn-outline-primary mt-3">
                                Читать далее
                            </a>

                            <!-- Кнопка редактирования (только для админа) -->
                            {% if user.is_staff or user.is_superuser %}
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-warning" onclick="toggleEditForm({{ news.id }})">
                                        <i class="bi bi-pencil-square"></i> Редактировать
                                    </button>
                                </div>

                                <!-- Форма редактирования (скрыта по умолчанию) -->
                                <div id="edit-form-{{ news.id }}" style="display:none; margin-top: 1rem; padding: 1rem; background: #fff8dc; border-radius: 0.5rem;">
                                    <form method="post" enctype="multipart/form-data" onsubmit="return submitEditForm(event, {{ news.id }})">
                                        {% csrf_token %}
                                        <input type="hidden" name="news_id" value="{{ news.id }}">

                                        <div class="mb-2">
                                            <label class="form-label">Заголовок</label>
                                            <input type="text" name="title" class="form-control" value="{{ news.title }}" required>
                                        </div>

                                        <div class="mb-2">
                                            <label class="form-label">Текст</label>
                                            <textarea name="content" class="form-control" rows="3" required>{{ news.content }}</textarea>
                                        </div>

                                        <div class="mb-2">
                                            <label class="form-label">Фото (необязательно)</label>
                                            <input type="file" name="image" class="form-control">
                                        </div>

                                        <button type="submit" class="btn btn-primary btn-sm">Сохранить</button>
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="toggleEditForm({{ news.id }})">Отмена</button>
                                    </form>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="d-flex justify-content-center gap-3 my-4">
            <a href="?page=1" class="btn btn-outline-warning">
                <i class="bi bi-arrow-up-circle me-1"></i> К последним новостям
            </a>
            {% if page_obj.paginator.num_pages > 1 %}
                <a href="?page={{ page_obj.paginator.num_pages }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-down-circle me-1"></i> Ранние новости
                </a>
            {% endif %}
        </div>

        <nav aria-label="Page navigation" class="my-5">
            <ul class="pagination justify-content-center pagination-secondary">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">← Предыдущая</a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">← Предыдущая</span>
                    </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% else %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}">Следующая →</a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">Следующая →</span>
                    </li>
                {% endif %}
            </ul>
        </nav>

    {% else %}
        <div class="alert alert-info text-center">
            <i class="bi bi-news"></i> Нет опубликованных новостей.
        </div>
    {% endif %}

    {% if user.is_authenticated %}
        <div class="text-end mb-4">
            <a href="{% url 'create_news' %}" class="btn btn-success">
                <i class="bi bi-plus-lg me-1"></i>Предложить новость
            </a>
        </div>
    {% endif %}

    <!-- JavaScript для редактирования -->
    <script>
        function toggleEditForm(newsId) {
            const form = document.getElementById('edit-form-' + newsId);
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        async function submitEditForm(event, newsId) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);

            try {
                const response = await fetch('/api/edit-news/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Обновляем DOM без перезагрузки
                    document.getElementById('title-' + newsId).innerText = formData.get('title');
                    document.getElementById('content-' + newsId).innerText = formData.get('content').substring(0, 200) + '...';

                    // Если загружено новое изображение — обновляем его
                    const imageFile = formData.get('image');
                    if (imageFile) {
                        const imgElement = document.getElementById('image-' + newsId);
                        if (imgElement && imgElement.tagName === 'IMG') {
                            imgElement.src = URL.createObjectURL(imageFile);
                        }
                    }

                    toggleEditForm(newsId); // Скрываем форму
                    alert('Новость успешно обновлена!');
                } else {
                    alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (err) {
                console.error('Ошибка:', err);
                alert('Произошла ошибка при отправке данных.');
            }
        }
    </script>
{% endblock %}